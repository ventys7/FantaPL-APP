import{c as ce,u as le,r as o,d as f,D as u,g as Q,Q as M,G,l as Z,I as Be,z as V,H as Ne,j as e,J as ie,q as Te,K as Re,k as de,M as Le,X as ae,L as $e,w as Ce,a as qe,A as se,T as Oe}from"./index-IQCk0ePk.js";import{C as me}from"./coins-eN-SbOWY.js";import{P as Ie}from"./plus--n6VeLsI.js";import{H as _e}from"./history-Cp8gdH11.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=ce("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ke=ce("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=ce("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),He=()=>{const{user:r}=le(),[x,k]=o.useState([]),[b,C]=o.useState([]),[N,j]=o.useState([]),[p,w]=o.useState([]),[c,S]=o.useState(!0),[P,s]=o.useState(null),d=o.useCallback(async()=>{if(r!=null&&r.$id)try{S(!0),s(null);const l=(await f.listDocuments(u,Q,[M.limit(100)])).documents.find(A=>A.manager_name===r.name);if(!l){S(!1);return}const $=l.$id,E=await f.listDocuments(u,G,[M.equal("receiver_team_id",$),M.equal("status","pending"),M.orderDesc("$createdAt")]),q=await f.listDocuments(u,G,[M.equal("proposer_team_id",$),M.equal("status","pending"),M.orderDesc("$createdAt")]),B=await f.listDocuments(u,G,[M.equal("status","accepted"),M.orderDesc("completed_at"),M.limit(50)]),T=B.documents.filter(A=>A.proposer_team_id===$||A.receiver_team_id===$);k(E.documents),C(q.documents),j(T),w(B.documents)}catch(i){Z.error("[useTrades] Error fetching proposals:",i),s(i.message||"Errore nel caricamento proposte")}finally{S(!1)}},[r==null?void 0:r.$id]);o.useEffect(()=>{d()},[d]);const h=async i=>{try{await f.createDocument(u,G,Be.unique(),{...i,status:"pending"}),await d()}catch(l){throw Z.error("[useTrades] Error creating proposal:",l),new Error(l.message||"Errore nella creazione proposta")}},v=async i=>{for(const l of i.proposer_players)await f.updateDocument(u,V,l,{owner:await n(i.receiver_team_id)});for(const l of i.receiver_players)await f.updateDocument(u,V,l,{owner:await n(i.proposer_team_id)});for(const l of i.proposer_gk_blocks){const $=await n(i.receiver_team_id);await f.updateDocument(u,Ne,l,{goalkeeper_owner:$});const E=await f.listDocuments(u,V,[M.equal("team_id",l),M.equal("position","Portiere")]);for(const q of E.documents)await f.updateDocument(u,V,q.$id,{owner:$})}for(const l of i.receiver_gk_blocks){const $=await n(i.proposer_team_id);await f.updateDocument(u,Ne,l,{goalkeeper_owner:$});const E=await f.listDocuments(u,V,[M.equal("team_id",l),M.equal("position","Portiere")]);for(const q of E.documents)await f.updateDocument(u,V,q.$id,{owner:$})}if(i.credits_offered!==0){const l=await f.getDocument(u,Q,i.proposer_team_id),$=await f.getDocument(u,Q,i.receiver_team_id),E=(l.credits_remaining||0)-i.credits_offered,q=($.credits_remaining||0)+i.credits_offered;await f.updateDocument(u,Q,i.proposer_team_id,{credits_remaining:E}),await f.updateDocument(u,Q,i.receiver_team_id,{credits_remaining:q})}},n=async i=>(await f.getDocument(u,Q,i)).manager_name;return{receivedProposals:x,sentProposals:b,tradeHistory:N,leagueHistory:p,loading:c,error:P,createProposal:h,acceptProposal:async i=>{try{const l=await f.getDocument(u,G,i);await v(l),await f.updateDocument(u,G,i,{status:"accepted",completed_at:new Date().toISOString()}),await d()}catch(l){throw Z.error("[useTrades] Error accepting proposal:",l),new Error(l.message||"Errore nell'accettazione proposta")}},rejectProposal:async i=>{try{await f.updateDocument(u,G,i,{status:"rejected",completed_at:new Date().toISOString()}),await d()}catch(l){throw Z.error("[useTrades] Error rejecting proposal:",l),new Error(l.message||"Errore nel rifiuto proposta")}},cancelProposal:async i=>{try{await f.updateDocument(u,G,i,{status:"cancelled",completed_at:new Date().toISOString()}),await d()}catch(l){throw Z.error("[useTrades] Error cancelling proposal:",l),new Error(l.message||"Errore nella cancellazione proposta")}},refresh:d}},Fe=({players:r,realTeams:x,ownerName:k,selectedPlayers:b,selectedBlocks:C,onTogglePlayer:N,onToggleBlock:j,disabled:p=!1})=>{const w=o.useMemo(()=>{const s={Portiere:[],Difensore:[],Centrocampista:[],Attaccante:[]};return r.forEach(d=>{s[d.position]&&s[d.position].push(d)}),Object.keys(s).forEach(d=>{s[d].sort((h,v)=>(v.quotation||0)-(h.quotation||0))}),s},[r]),c=o.useMemo(()=>{const s=new Map,d=new Set(x.filter(n=>n.goalkeeper_owner===k).map(n=>n.$id));return r.filter(n=>n.position==="Portiere"&&d.has(n.team_id)).forEach(n=>{if(!s.has(n.team_id)){const _=x.find(z=>z.$id===n.team_id);s.set(n.team_id,{teamId:n.team_id,teamName:n.team_short_name,gks:[],quotation:(_==null?void 0:_.goalkeeper_quotation)||0})}s.get(n.team_id).gks.push(n)}),Array.from(s.values())},[r,x,k]),S=(s,d=!1)=>{const h=b.has(s.$id);return e.jsxs("div",{onClick:()=>!p&&!d&&N(s.$id),className:`flex items-center gap-3 px-3 py-2 transition cursor-pointer border-b border-white/5 last:border-b-0
                    ${h?"bg-pl-teal/20 border-pl-teal/30":"hover:bg-white/5"}
                    ${p?"opacity-50 cursor-not-allowed":""}
                    ${d?"pl-8 opacity-70":""}
                `,children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition
                    ${h?"bg-pl-teal border-pl-teal":"border-white/30"}
                `,children:h&&e.jsx(oe,{size:12,className:"text-pl-dark"})}),e.jsx("img",{src:s.image_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=3d195b&color=fff`,alt:s.name,className:"w-8 h-8 rounded-full object-cover bg-white/10"}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-bold border ${ie[s.position]||ie.Unknown}`,children:Re[s.position]||"?"}),e.jsx("span",{className:"flex-1 text-sm text-white truncate",children:s.name}),e.jsx("span",{className:"text-xs text-gray-500",children:s.team_short_name}),e.jsx("span",{className:"text-sm font-mono text-gray-400 w-8 text-right",children:s.quotation})]},s.$id)},P=s=>{const d=C.has(s.teamId),h=s.gks.map(_=>_.$id),n=`https://images.fotmob.com/image_resources/logo/teamlogo/${s.teamId.replace("team_","")}.png`;return e.jsxs("div",{className:"border-b border-white/5 last:border-b-0",children:[e.jsxs("div",{onClick:()=>!p&&j(s.teamId,h),className:`flex items-center gap-3 px-3 py-2 transition cursor-pointer
                        ${d?"bg-pl-teal/20":"hover:bg-white/5"}
                        ${p?"opacity-50 cursor-not-allowed":""}
                    `,children:[e.jsx("div",{className:`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 transition
                        ${d?"bg-pl-teal border-pl-teal":"border-white/30"}
                    `,children:d&&e.jsx(oe,{size:12,className:"text-pl-dark"})}),e.jsx("img",{src:n,alt:s.teamName,className:"w-8 h-8 object-contain",onError:_=>{_.target.src="https://via.placeholder.com/32?text=?"}}),e.jsx("span",{className:`px-2 py-0.5 rounded-full text-[10px] font-bold border ${ie.Portiere}`,children:"P"}),e.jsxs("span",{className:"flex-1 text-sm text-white",children:["Blocco ",s.teamName]}),e.jsx(Te,{size:14,className:"text-yellow-500"}),e.jsx("span",{className:"text-sm font-mono text-gray-400 w-8 text-right",children:s.quotation})]}),d&&e.jsx("div",{className:"bg-black/20 border-t border-white/5",children:s.gks.map(_=>e.jsxs("div",{className:"flex items-center gap-3 px-3 py-1.5 pl-12 text-xs text-gray-400",children:[e.jsx("img",{src:_.image_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(_.name)}&background=3d195b&color=fff`,alt:_.name,className:"w-6 h-6 rounded-full object-cover bg-white/10"}),e.jsx("span",{className:"flex-1",children:_.name})]},_.$id))})]},s.teamId)};return e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-xl overflow-hidden",children:[c.length>0&&e.jsxs("div",{className:"border-b border-white/10",children:[e.jsx("div",{className:"px-3 py-2 bg-black/20 text-xs font-bold text-gray-400 uppercase tracking-wider",children:"Portieri (Blocchi)"}),c.map(s=>P(s))]}),w.Difensore.length>0&&e.jsxs("div",{className:"border-b border-white/10",children:[e.jsxs("div",{className:"px-3 py-2 bg-black/20 text-xs font-bold text-gray-400 uppercase tracking-wider",children:["Difensori (",w.Difensore.length,")"]}),w.Difensore.map(s=>S(s))]}),w.Centrocampista.length>0&&e.jsxs("div",{className:"border-b border-white/10",children:[e.jsxs("div",{className:"px-3 py-2 bg-black/20 text-xs font-bold text-gray-400 uppercase tracking-wider",children:["Centrocampisti (",w.Centrocampista.length,")"]}),w.Centrocampista.map(s=>S(s))]}),w.Attaccante.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"px-3 py-2 bg-black/20 text-xs font-bold text-gray-400 uppercase tracking-wider",children:["Attaccanti (",w.Attaccante.length,")"]}),w.Attaccante.map(s=>S(s))]}),r.length===0&&e.jsx("div",{className:"px-6 py-8 text-center text-gray-500",children:"Nessun giocatore in rosa"})]})},te=({proposal:r,type:x,proposerName:k,receiverName:b,proposerPlayerNames:C,receiverPlayerNames:N,proposerBlockNames:j,receiverBlockNames:p,onAccept:w,onReject:c,onCancel:S,loading:P=!1})=>{const s=v=>new Date(v).toLocaleDateString("it-IT",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"}),d=C.length+j.length,h=N.length+p.length;return e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-xl overflow-hidden hover:border-white/20 transition",children:[e.jsxs("div",{className:"px-4 py-3 bg-black/20 border-b border-white/5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{size:16,className:"text-pl-teal"}),e.jsx("span",{className:"text-sm font-medium text-white",children:x==="received"?`Da ${k}`:x==="sent"?`A ${b}`:`${k} â†” ${b}`})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx(Le,{size:12}),s(r.$createdAt)]})]}),e.jsxs("div",{className:"p-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] uppercase font-bold text-gray-500 mb-2",children:x==="received"?"Ricevi":"Offre"}),e.jsxs("div",{className:"space-y-1",children:[C.map((v,n)=>e.jsx("div",{className:"text-sm text-white bg-white/5 px-2 py-1 rounded",children:v},n)),j.map((v,n)=>e.jsxs("div",{className:"text-sm text-yellow-400 bg-yellow-500/10 px-2 py-1 rounded flex items-center gap-1",children:["ðŸ§¤ Blocco ",v]},`block-${n}`)),d===0&&e.jsx("div",{className:"text-sm text-gray-500 italic",children:"Nessun giocatore"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[10px] uppercase font-bold text-gray-500 mb-2",children:x==="received"?"Dai":"Richiede"}),e.jsxs("div",{className:"space-y-1",children:[N.map((v,n)=>e.jsx("div",{className:"text-sm text-white bg-white/5 px-2 py-1 rounded",children:v},n)),p.map((v,n)=>e.jsxs("div",{className:"text-sm text-yellow-400 bg-yellow-500/10 px-2 py-1 rounded flex items-center gap-1",children:["ðŸ§¤ Blocco ",v]},`block-${n}`)),h===0&&e.jsx("div",{className:"text-sm text-gray-500 italic",children:"Nessun giocatore"})]})]})]}),r.credits_offered!==0&&e.jsx("div",{className:"px-4 pb-3",children:e.jsxs("div",{className:`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium ${r.credits_offered>0?x==="received"?"bg-green-500/20 text-green-400":"bg-red-500/20 text-red-400":x==="received"?"bg-red-500/20 text-red-400":"bg-green-500/20 text-green-400"}`,children:[e.jsx(me,{size:14}),x==="received"?r.credits_offered>0?`+${r.credits_offered} crediti`:`${r.credits_offered} crediti`:r.credits_offered>0?`-${r.credits_offered} crediti`:`+${Math.abs(r.credits_offered)} crediti`]})}),x!=="history"&&e.jsxs("div",{className:"px-4 py-3 bg-black/20 border-t border-white/5 flex gap-2 justify-end",children:[x==="received"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:c,disabled:P,className:"flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition text-sm font-medium disabled:opacity-50",children:[e.jsx(ae,{size:14}),"Rifiuta"]}),e.jsxs("button",{onClick:w,disabled:P,className:"flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500/30 transition text-sm font-medium disabled:opacity-50",children:[e.jsx(oe,{size:14}),"Accetta"]})]}),x==="sent"&&e.jsxs("button",{onClick:S,disabled:P,className:"flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-500/20 text-gray-400 hover:bg-gray-500/30 transition text-sm font-medium disabled:opacity-50",children:[e.jsx(ae,{size:14}),"Annulla"]})]}),x==="history"&&e.jsx("div",{className:"px-4 py-2 bg-green-500/10 border-t border-green-500/20 text-center",children:e.jsxs("span",{className:"text-xs font-bold text-green-400 uppercase",children:["âœ“ Completato il ",s(r.completed_at||r.$updatedAt)]})})]})},Ue=({isOpen:r,loading:x,mySelectedPlayers:k,mySelectedBlocks:b,opponentSelectedPlayers:C,opponentSelectedBlocks:N,creditsOffered:j,onClose:p,onConfirm:w})=>r?e.jsx("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center p-4 z-10 animate-in fade-in duration-200",children:e.jsxs("div",{className:"bg-[#18181b] border border-white/20 rounded-xl p-6 max-w-md w-full max-h-[80vh] overflow-y-auto animate-in zoom-in-95 duration-200 shadow-2xl",children:[e.jsx("h3",{className:"text-lg font-bold text-white mb-4",children:"Conferma Proposta"}),e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-red-400 mb-2",children:"Offri"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[k.map(c=>e.jsxs("div",{className:"flex items-center gap-2 bg-white/5 px-2 py-1 rounded",children:[e.jsx("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded ${c.position==="Difensore"?"bg-blue-500/30 text-blue-400":c.position==="Centrocampista"?"bg-green-500/30 text-green-400":"bg-red-500/30 text-red-400"}`,children:c.position==="Difensore"?"D":c.position==="Centrocampista"?"C":"A"}),e.jsx("span",{className:"text-white",children:c.name})]},c.$id)),b.map(c=>e.jsxs("div",{className:"flex items-center gap-2 bg-yellow-500/10 px-2 py-1 rounded text-yellow-400",children:[e.jsx("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded bg-yellow-500/30",children:"P"}),"Blocco ",(c==null?void 0:c.short_name)||"Squadra"]},c.$id)),j>0&&e.jsxs("div",{className:"flex items-center gap-2 bg-green-500/10 px-2 py-1 rounded text-green-400",children:["ðŸ’° +",j," crediti"]}),k.length===0&&b.length===0&&j<=0&&e.jsx("span",{className:"text-gray-500 italic text-xs",children:"Nessun giocatore o credito offerto"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"text-xs uppercase font-bold text-green-400 mb-2",children:"Richiedi"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[C.map(c=>e.jsxs("div",{className:"flex items-center gap-2 bg-white/5 px-2 py-1 rounded",children:[e.jsx("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded ${c.position==="Difensore"?"bg-blue-500/30 text-blue-400":c.position==="Centrocampista"?"bg-green-500/30 text-green-400":"bg-red-500/30 text-red-400"}`,children:c.position==="Difensore"?"D":c.position==="Centrocampista"?"C":"A"}),e.jsx("span",{className:"text-white",children:c.name})]},c.$id)),N.map(c=>e.jsxs("div",{className:"flex items-center gap-2 bg-yellow-500/10 px-2 py-1 rounded text-yellow-400",children:[e.jsx("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded bg-yellow-500/30",children:"P"}),"Blocco ",(c==null?void 0:c.short_name)||"Squadra"]},c.$id)),j<0&&e.jsxs("div",{className:"flex items-center gap-2 bg-green-500/10 px-2 py-1 rounded text-green-400",children:["ðŸ’° +",Math.abs(j)," crediti"]}),C.length===0&&N.length===0&&j>=0&&e.jsx("span",{className:"text-gray-500 italic text-xs",children:"Nessun giocatore o credito richiesto"})]})]}),e.jsxs("div",{className:"flex gap-3 justify-end pt-4 border-t border-white/5",children:[e.jsx("button",{onClick:p,className:"px-4 py-2 rounded-lg bg-white/10 text-gray-300 hover:bg-white/20 transition text-sm font-medium",children:"Annulla"}),e.jsxs("button",{onClick:w,disabled:x,className:"flex items-center gap-2 px-4 py-2 rounded-lg bg-pl-teal text-pl-dark font-bold hover:bg-pl-teal/90 transition disabled:opacity-50 text-sm shadow-lg shadow-pl-teal/20",children:[x?e.jsx($e,{size:16,className:"animate-spin"}):e.jsx(xe,{size:16}),"Conferma Scambio"]})]})]})}):null,Se=({title:r,subtitle:x,credits:k,showCredits:b=!0,players:C,realTeams:N,selectedPlayers:j,selectedBlocks:p,onTogglePlayer:w,onToggleBlock:c,ownerName:S,children:P,emptyMessage:s,isActive:d})=>e.jsxs("div",{className:`flex-1 flex-col overflow-hidden ${d?"flex":"hidden md:flex"} ${r==="La Mia Rosa"?"border-r border-white/10":""}`,children:[e.jsxs("div",{className:`px-4 py-3 border-b border-white/5 flex-shrink-0 flex items-center justify-between ${r==="La Mia Rosa"?"bg-pl-teal/10":"bg-black/20"}`,children:[e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2",children:P||e.jsx("h3",{className:"font-bold text-white",children:r})}),e.jsx("p",{className:"text-xs text-gray-400 mt-0.5",children:x})]}),b&&e.jsxs("div",{className:"flex items-center gap-1.5 px-3 py-1.5 bg-black/30 rounded-lg border border-white/5",children:[e.jsx(me,{size:14,className:"text-pl-teal"}),e.jsx("span",{className:"text-sm font-mono font-bold text-pl-teal",children:k})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 custom-scrollbar",children:C.length>0||s===void 0?e.jsx(Fe,{players:C,realTeams:N,ownerName:S,selectedPlayers:j,selectedBlocks:p,onTogglePlayer:w,onToggleBlock:c}):e.jsx("div",{className:"flex items-center justify-center h-full text-gray-500 text-sm italic px-10 text-center",children:s})})]}),Ge=({isOpen:r,onClose:x,onSubmit:k,myTeamId:b,myUserId:C})=>{const{players:N,realTeams:j}=Ce(),{user:p}=le(),[w,c]=o.useState([]),[S,P]=o.useState(""),[s,d]=o.useState(new Set),[h,v]=o.useState(new Set),[n,_]=o.useState(new Set),[z,Y]=o.useState(new Set),[i,l]=o.useState(0),[$,E]=o.useState("offer"),[q,B]=o.useState(!1),[T,A]=o.useState(!1),[O,W]=o.useState(null),[J,ee]=o.useState("my-team"),[K,t]=o.useState([]);o.useEffect(()=>{r&&(async()=>{try{const y=(await f.listDocuments(u,Q,[M.limit(100)])).documents.filter(L=>L.role!=="g_admin");t(y),c(y.filter(L=>L.$id!==b))}catch(m){console.error("Error fetching teams:",m)}})()},[r,b]);const g=o.useMemo(()=>{const a=K.find(m=>m.$id===b)||{manager_name:(p==null?void 0:p.name)||""};return N.filter(m=>m.owner===a.manager_name||m.owner===(p==null?void 0:p.name))},[N,b,K,p]),R=o.useMemo(()=>{const a=K.find(m=>m.$id===b);return(a==null?void 0:a.credits_remaining)||0},[K,b]),D=o.useMemo(()=>w.find(a=>a.$id===S),[w,S]),I=o.useMemo(()=>D?N.filter(a=>a.owner===D.manager_name):[],[N,D]),pe=(a,m)=>{const y={D:0,C:0,A:0};return a.forEach(L=>{const H=m.find(X=>X.$id===L);H&&(H.position==="Difensore"?y.D++:H.position==="Centrocampista"?y.C++:H.position==="Attaccante"&&y.A++)}),y},F=pe(s,g),U=pe(n,I),he=s.size+h.size,ge=n.size+z.size,fe=F.D===U.D&&F.C===U.C&&F.A===U.A&&h.size===z.size,ue=s.size>0||h.size>0||n.size>0||z.size>0,Pe=fe&&ue&&s.size+h.size>0&&n.size+z.size>0,be=$==="offer"?i:-i,we=$==="offer"?i<=R:i<=((D==null?void 0:D.credits_remaining)||0),De=a=>{const m=new Set(s);m.has(a)?m.delete(a):m.add(a),d(m)},ze=(a,m)=>{const y=new Set(h);y.has(a)?y.delete(a):y.add(a),v(y)},Ae=a=>{const m=new Set(n);m.has(a)?m.delete(a):m.add(a),_(m)},Me=(a,m)=>{const y=new Set(z);y.has(a)?y.delete(a):y.add(a),Y(y)},Ee=async()=>{if(!D)return;const a={proposer_user_id:C,receiver_user_id:"",proposer_team_id:b,receiver_team_id:S,proposer_players:Array.from(s).filter(m=>!Array.from(h).some(y=>{var L;return((L=N.find(H=>H.$id===m))==null?void 0:L.team_id)===y})),receiver_players:Array.from(n).filter(m=>!Array.from(z).some(y=>{var L;return((L=N.find(H=>H.$id===m))==null?void 0:L.team_id)===y})),proposer_gk_blocks:Array.from(h),receiver_gk_blocks:Array.from(z),credits_offered:be};try{A(!0),W(null),await k(a),re()}catch(m){W(m.message||"Errore nell'invio proposta")}finally{A(!1)}},re=()=>{P(""),d(new Set),v(new Set),_(new Set),Y(new Set),l(0),E("offer"),B(!1),W(null),x()};if(!r)return null;const ye=(a,m,y)=>{const L=Array.from(a).map(X=>y.find(ne=>ne.$id===X)).filter(Boolean),H=Array.from(m).map(X=>j.find(ne=>ne.$id===X)).filter(Boolean);return{sPlayers:L,sBlocks:H}},je=ye(s,h,g),ve=ye(n,z,I);return qe.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[99999] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80 transition-opacity",onClick:re}),e.jsxs("div",{className:"relative w-full max-w-6xl h-[80vh] md:h-auto md:max-h-[85vh] bg-[#18181b] rounded-2xl border border-white/10 shadow-2xl overflow-hidden flex flex-col md:flex animate-in zoom-in-95 duration-200",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-white/10 bg-black/20 flex-shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"text-pl-teal",size:20}),e.jsx("h2",{className:"text-xl font-bold text-white",children:"Nuovo Scambio"})]}),e.jsx("button",{onClick:re,className:"p-2 hover:bg-white/10 rounded-lg transition text-gray-400 hover:text-white",children:e.jsx(ae,{size:20})})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex md:hidden border-b border-white/10 shrink-0",children:[e.jsxs("button",{onClick:()=>ee("my-team"),className:`flex-1 py-3 text-sm font-bold text-center border-b-2 transition ${J==="my-team"?"border-pl-teal text-white bg-white/5":"border-transparent text-gray-500"}`,children:["La Mia Rosa ",he>0&&e.jsxs("span",{className:"ml-1 text-pl-teal",children:["(",he,")"]})]}),e.jsxs("button",{onClick:()=>ee("opponent-team"),className:`flex-1 py-3 text-sm font-bold text-center border-b-2 transition ${J==="opponent-team"?"border-pl-teal text-white bg-white/5":"border-transparent text-gray-500"}`,children:["Altro Partecipante ",ge>0&&e.jsxs("span",{className:"ml-1 text-pl-teal",children:["(",ge,")"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col md:flex-row relative",children:[e.jsx(Se,{title:"La Mia Rosa",subtitle:"Seleziona i giocatori da offrire",credits:R,players:g,realTeams:j,selectedPlayers:s,selectedBlocks:h,onTogglePlayer:De,onToggleBlock:ze,ownerName:(p==null?void 0:p.name)||"",isActive:J==="my-team"}),e.jsx(Se,{title:"",subtitle:"Seleziona i giocatori da richiedere",credits:(D==null?void 0:D.credits_remaining)||0,showCredits:!!D,players:I,realTeams:j,selectedPlayers:n,selectedBlocks:z,onTogglePlayer:Ae,onToggleBlock:Me,ownerName:(D==null?void 0:D.manager_name)||"",emptyMessage:"Seleziona un partecipante per vedere la sua rosa",isActive:J==="opponent-team",children:e.jsxs("div",{className:"inline-flex items-center gap-1",children:[e.jsx("svg",{className:"w-4 h-4 text-gray-400 pointer-events-none",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})}),e.jsxs("select",{value:S,onChange:a=>{P(a.target.value),_(new Set),Y(new Set)},className:"bg-transparent text-white text-base font-bold focus:outline-none cursor-pointer appearance-none",children:[e.jsx("option",{value:"",children:"Seleziona partecipante..."}),w.filter(a=>a.$id!==b&&a.manager_name!==(p==null?void 0:p.name)&&a.user_id!==C).map(a=>e.jsxs("option",{value:a.$id,children:[a.manager_name," - ",a.team_name]},a.$id))]})]})})]})]}),e.jsxs("div",{className:"p-4 border-t border-white/10 bg-black/20 flex-shrink-0",children:[e.jsx("div",{className:"flex flex-col md:flex-row items-start md:items-center gap-4 mb-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(me,{size:16,className:"text-pl-teal"}),e.jsx("span",{className:"text-sm text-gray-400",children:"Crediti:"}),e.jsxs("div",{className:"flex rounded-lg overflow-hidden border border-white/20",children:[e.jsx("button",{onClick:()=>E("offer"),className:`px-3 py-1.5 text-xs font-bold transition ${$==="offer"?"bg-red-500/30 text-red-400":"bg-white/5 text-gray-400 hover:bg-white/10"}`,children:"Offri"}),e.jsx("button",{onClick:()=>E("request"),className:`px-3 py-1.5 text-xs font-bold transition ${$==="request"?"bg-green-500/30 text-green-400":"bg-white/5 text-gray-400 hover:bg-white/10"}`,children:"Richiedi"})]}),e.jsx("input",{type:"number",min:"0",value:i===0?"":i,onChange:a=>l(a.target.value===""?0:Math.abs(parseInt(a.target.value))||0),className:"w-20 bg-white/10 border border-white/20 rounded-lg px-3 py-1.5 text-white text-sm text-center focus:border-pl-teal outline-none",placeholder:"0"})]})}),e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[ue&&!fe&&e.jsxs("div",{className:"flex items-center gap-1.5 text-yellow-400 text-sm flex-wrap",children:[e.jsx(se,{size:14,className:"flex-shrink-0"}),e.jsxs("span",{children:["Ruoli non bilanciati:",F.D!==U.D&&` D(${F.D}â†”${U.D})`,F.C!==U.C&&` C(${F.C}â†”${U.C})`,F.A!==U.A&&` A(${F.A}â†”${U.A})`,h.size!==z.size&&` P(${h.size}â†”${z.size})`]})]}),!we&&e.jsxs("div",{className:"flex items-center gap-1.5 text-red-400 text-sm",children:[e.jsx(se,{size:14}),"Crediti insufficienti"]}),O&&e.jsxs("div",{className:"flex items-center gap-1.5 text-red-400 text-sm",children:[e.jsx(se,{size:14}),O]})]}),e.jsxs("button",{onClick:()=>B(!0),disabled:!Pe||!we||!S||T,className:"flex items-center gap-2 px-6 py-2.5 rounded-xl bg-pl-teal text-pl-dark font-bold hover:bg-pl-teal/90 transition disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(xe,{size:16}),"Invia Proposta"]})]})]}),e.jsx(Ue,{isOpen:q,loading:T,mySelectedPlayers:je.sPlayers,mySelectedBlocks:je.sBlocks,opponentSelectedPlayers:ve.sPlayers,opponentSelectedBlocks:ve.sBlocks,creditsOffered:be,onClose:()=>B(!1),onConfirm:Ee})]})]}),document.body)},Ve=()=>{const{user:r}=le(),{receivedProposals:x,sentProposals:k,tradeHistory:b,leagueHistory:C,loading:N,error:j,createProposal:p,acceptProposal:w,rejectProposal:c,cancelProposal:S}=He(),{players:P}=Ce(),[s,d]=o.useState(!1),[h,v]=o.useState(!1),[n,_]=o.useState(""),[z,Y]=o.useState(new Map),[i,l]=o.useState(new Map),[$,E]=o.useState(new Map),[q,B]=o.useState(null);o.useEffect(()=>{(async()=>{try{const g=await f.listDocuments(u,Q,[M.limit(100)]),R=new Map;g.documents.forEach(I=>{R.set(I.$id,I),I.user_id&&R.set(I.user_id,I)}),Y(R);const D=g.documents.find(I=>I.manager_name===(r==null?void 0:r.name));D&&_(D.$id)}catch(g){console.error("Error fetching fantasy teams:",g)}})()},[r==null?void 0:r.name]),o.useEffect(()=>{const t=new Map;P.forEach(R=>t.set(R.$id,R.name)),l(t);const g=new Map;P.forEach(R=>{g.has(R.team_id)||g.set(R.team_id,R.team_short_name)}),E(g)},[P]);const T=t=>{var g;return((g=z.get(t))==null?void 0:g.manager_name)||"Sconosciuto"},A=t=>t.map(g=>i.get(g)||"Giocatore sconosciuto"),O=t=>t.map(g=>$.get(g)||"Squadra"),W=async t=>{B(t);try{await w(t)}catch(g){console.error("Error accepting:",g)}finally{B(null)}},J=async t=>{B(t);try{await c(t)}catch(g){console.error("Error rejecting:",g)}finally{B(null)}},ee=async t=>{B(t);try{await S(t)}catch(g){console.error("Error cancelling:",g)}finally{B(null)}},K=async t=>{await p(t)};return N?e.jsxs("div",{className:"flex flex-col items-center justify-center h-96 gap-4",children:[e.jsx($e,{className:"h-8 w-8 animate-spin text-pl-teal"}),e.jsx("span",{className:"text-gray-400",children:"Caricamento mercato scambi..."})]}):e.jsxs("div",{className:"w-full px-4 md:px-12 lg:px-24 xl:px-32 container mx-auto pb-20",children:[e.jsxs("div",{className:"flex flex-col md:flex-row items-start md:items-center justify-between mb-8 mt-6 gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold text-white flex items-center gap-3",children:[e.jsx(de,{className:"text-pl-teal"}),"Mercato Scambi"]}),e.jsx("p",{className:"text-gray-400 mt-1",children:"Proponi e gestisci scambi con altri partecipanti"})]}),e.jsxs("div",{className:"flex items-center gap-3 w-full md:w-auto",children:[e.jsxs("button",{onClick:()=>d(!0),className:"flex items-center justify-center gap-2 px-6 py-3 rounded-xl bg-pl-teal text-pl-dark font-bold hover:bg-pl-teal/90 transition flex-1 md:flex-none",children:[e.jsx(Ie,{size:20}),"Nuovo Scambio"]}),e.jsxs("button",{onClick:()=>v(!0),className:"flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white font-bold hover:bg-white/10 transition flex-none",children:[e.jsx(ke,{size:20,className:"text-blue-400"}),e.jsx("span",{className:"hidden md:inline",children:"Storico Lega"})]})]})]}),j&&e.jsxs("div",{className:"mb-6 p-4 bg-red-500/10 border border-red-500/30 rounded-xl flex items-center gap-3 text-red-400",children:[e.jsx(se,{size:20}),j]}),e.jsxs("section",{className:"mb-8",children:[e.jsxs("h2",{className:"text-lg font-bold text-white flex items-center gap-2 mb-4",children:[e.jsx(Oe,{size:20,className:"text-green-400"}),"Proposte Ricevute",x.length>0&&e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-green-500/20 text-green-400 text-xs font-bold rounded-full",children:x.length})]}),x.length===0?e.jsx("div",{className:"bg-white/5 border border-white/10 rounded-xl p-8 text-center text-gray-500",children:"Nessuna proposta ricevuta"}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:x.map(t=>e.jsx(te,{proposal:t,type:"received",proposerName:T(t.proposer_team_id),receiverName:T(t.receiver_team_id),proposerPlayerNames:A(t.proposer_players),receiverPlayerNames:A(t.receiver_players),proposerBlockNames:O(t.proposer_gk_blocks),receiverBlockNames:O(t.receiver_gk_blocks),onAccept:()=>W(t.$id),onReject:()=>J(t.$id),loading:q===t.$id},t.$id))})]}),e.jsxs("section",{className:"mb-8",children:[e.jsxs("h2",{className:"text-lg font-bold text-white flex items-center gap-2 mb-4",children:[e.jsx(xe,{size:20,className:"text-blue-400"}),"Proposte Inviate",k.length>0&&e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-blue-500/20 text-blue-400 text-xs font-bold rounded-full",children:k.length})]}),k.length===0?e.jsx("div",{className:"bg-white/5 border border-white/10 rounded-xl p-8 text-center text-gray-500",children:"Nessuna proposta inviata"}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:k.map(t=>e.jsx(te,{proposal:t,type:"sent",proposerName:T(t.proposer_team_id),receiverName:T(t.receiver_team_id),proposerPlayerNames:A(t.proposer_players),receiverPlayerNames:A(t.receiver_players),proposerBlockNames:O(t.proposer_gk_blocks),receiverBlockNames:O(t.receiver_gk_blocks),onCancel:()=>ee(t.$id),loading:q===t.$id},t.$id))})]}),e.jsxs("section",{children:[e.jsxs("h2",{className:"text-lg font-bold text-white flex items-center gap-2 mb-4",children:[e.jsx(_e,{size:20,className:"text-gray-400"}),"Storico Scambi"]}),b.length===0?e.jsx("div",{className:"bg-white/5 border border-white/10 rounded-xl p-8 text-center text-gray-500",children:"Nessuno scambio completato"}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:b.map(t=>e.jsx(te,{proposal:t,type:"history",proposerName:T(t.proposer_team_id),receiverName:T(t.receiver_team_id),proposerPlayerNames:A(t.proposer_players),receiverPlayerNames:A(t.receiver_players),proposerBlockNames:O(t.proposer_gk_blocks),receiverBlockNames:O(t.receiver_gk_blocks)},t.$id))})]}),e.jsx(Ge,{isOpen:s,onClose:()=>d(!1),onSubmit:K,myTeamId:n,myUserId:(r==null?void 0:r.$id)||""}),h&&e.jsxs("div",{className:"fixed inset-0 z-[99999] flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/80",onClick:()=>v(!1)}),e.jsxs("div",{className:"relative bg-[#18181b] w-full max-w-4xl h-[80vh] rounded-2xl border border-white/10 shadow-2xl flex flex-col overflow-hidden animate-in fade-in zoom-in-95 duration-200",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"p-4 border-b border-white/10 bg-black/20 flex items-center justify-between",children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(ke,{className:"text-blue-400"}),"Storico Scambi Lega"]}),e.jsx("button",{onClick:()=>v(!1),className:"p-2 hover:bg-white/10 rounded-lg text-gray-400 hover:text-white transition",children:e.jsx(ae,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 bg-[#18181b]",children:C.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-48 text-gray-500 italic",children:[e.jsx(_e,{size:32,className:"mb-2 opacity-50"}),"Nessuno scambio concluso nella lega"]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:C.map(t=>e.jsx(te,{proposal:t,type:"history",proposerName:T(t.proposer_team_id),receiverName:T(t.receiver_team_id),proposerPlayerNames:A(t.proposer_players),receiverPlayerNames:A(t.receiver_players),proposerBlockNames:O(t.proposer_gk_blocks),receiverBlockNames:O(t.receiver_gk_blocks)},t.$id))})})]})]})]})};export{Ve as TradeMarket};
